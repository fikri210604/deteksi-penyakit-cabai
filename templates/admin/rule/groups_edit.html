{% extends 'app.html' %}
{% block title %}Edit Kelompok Rule - Admin{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto">
    
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
        Edit Kelompok Rule
    </h1>
    
    <form method="post" class="bg-white rounded-xl shadow-2xl p-8 border border-gray-100 space-y-8">
        
        <fieldset class="space-y-4 border border-gray-200 p-6 rounded-lg">
            <legend class="text-xl font-semibold text-gray-700 px-2">Informasi Dasar</legend>
            
            <div class="grid md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                    <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelompok (Opsional)</label>
                    <input id="nama" name="nama" value="{{ group.nama or '' }}" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Contoh: Rule Utama Diabetes" />
                </div>
                <div class="md:col-span-2">
                    <label for="keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Rule (Opsional)</label>
                    <textarea id="keterangan" name="keterangan" rows="3" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Jelaskan kapan rule ini harus dipicu...">{{ group.keterangan or '' }}</textarea>
                </div>
            </div>

            <div class="grid md:grid-cols-4 gap-4 pt-4 border-t border-dashed">
                <div>
                    <label for="kode_penyakit" class="block text-sm font-medium text-gray-700 mb-1">Penyakit (Konsekuen)</label>
                    <select id="kode_penyakit" name="kode_penyakit" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white" required>
                        {% for p in penyakit %}
                            <option value="{{ p.kode_penyakit }}" {% if p.kode_penyakit == group.kode_penyakit %}selected{% endif %}>{{ p.kode_penyakit }} - {{ p.nama }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="consequent_term" class="block text-sm font-medium text-gray-700 mb-1">Term Konsekuen (Sugeno)</label>
                    <select id="consequent_term" name="consequent_term" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-indigo-500 focus:border-indigo-500 bg-white" required>
                        <option value="rendah" {% if group.consequent_term == 'rendah' %}selected{% endif %}>rendah</option>
                        <option value="sedang" {% if group.consequent_term == 'sedang' %}selected{% endif %}>sedang</option>
                        <option value="tinggi" {% if group.consequent_term == 'tinggi' %}selected{% endif %}>tinggi</option>
                    </select>
                </div>
                <div>
                    <label for="bobot" class="block text-sm font-medium text-gray-700 mb-1">Bobot Rule (0.0 - 1.0)</label>
                    <input id="bobot" name="bobot" type="number" min="0" max="1" step="0.1" value="{{ group.bobot or 1 }}" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div class="flex items-center pt-6">
                    <input id="aktif" name="aktif" type="checkbox" {% if group.aktif %}checked{% endif %} class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                    <label for="aktif" class="ml-2 block text-sm font-medium text-gray-700">Aktifkan Rule</label>
                </div>
            </div>

            <div class="pt-2">
                <label for="z_override" class="block text-sm font-medium text-gray-700 mb-1">Z Override (0.00 - 1.00, Opsional)</label>
                <input id="z_override" name="z_override" type="number" min="0" max="1" step="0.01" value="{{ group.z_override if group.z_override is not none else '' }}" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-red-500 focus:border-red-500" placeholder="Kosongkan untuk menggunakan Z default" />
                <p class="text-xs text-gray-500 mt-1">**Peringatan:** Jika diisi, nilai ini (z={{ group.z_override if group.z_override is not none else '0.50' }}) akan **menggantikan** nilai z default (rendah=0.2, sedang=0.5, tinggi=0.8) untuk penyakit **{{ group.kode_penyakit }}**.</p>
            </div>
        </fieldset>
        
        <fieldset class="space-y-4 border border-gray-200 p-6 rounded-lg">
            <legend class="text-xl font-semibold text-gray-700 px-2">Kondisi Rule (Antecedent)</legend>
            
            <p class="text-sm text-gray-600">Definisikan kondisi Gejala (IF) yang harus terpenuhi agar rule ini menghasilkan diagnosis (THEN). Minimal 2 kondisi diperlukan.</p>

            <div id="rows" class="space-y-3">
                {% set default_terms = ['tidak_ada','sedikit','sedang','banyak','sangat_banyak'] %}

                {% for cond in group.kondisi %}
                    <div class="grid grid-cols-12 gap-3 condition-row p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="col-span-5">
                            <label class="sr-only">Gejala</label>
                            <select name="kode_gejala[]" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Gejala</option>
                                {% for g in gejala %}
                                    <option value="{{ g.kode }}" {% if cond.kode_gejala == g.kode %}selected{% endif %}>{{ g.kode }} - {{ g.nama }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-span-5">
                            <label class="sr-only">Term</label>
                            <select name="antecedent_term[]" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Term</option>
                                {% for t in default_terms %}
                                    <option value="{{ t }}" {% if cond.antecedent_term == t %}selected{% endif %}>{{ t | replace('_', ' ') | title }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-span-2 flex items-center justify-end">
                            <button type="button" class="btn-remove p-2 text-red-600 hover:text-red-800 rounded-full hover:bg-red-100 transition duration-150" title="Hapus Kondisi">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                {% else %}
                    <div class="grid grid-cols-12 gap-3 condition-row p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="col-span-5">
                            <label class="sr-only">Gejala</label>
                            <select name="kode_gejala[]" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Gejala</option>
                                {% for g in gejala %}
                                    <option value="{{ g.kode }}">{{ g.kode }} - {{ g.nama }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-span-5">
                            <label class="sr-only">Term</label>
                            <select name="antecedent_term[]" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Term</option>
                                {% for t in default_terms %}
                                    <option value="{{ t }}">{{ t | replace('_', ' ') | title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-span-2 flex items-center justify-end">
                            <button type="button" class="btn-remove p-2 text-red-600 hover:text-red-800 rounded-full hover:bg-red-100 transition duration-150" title="Hapus Kondisi">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="pt-4 flex justify-between items-center">
                <button type="button" id="btnAdd" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-50 border border-indigo-300 rounded-lg hover:bg-indigo-100 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Tambah Kondisi Gejala
                </button>
                <p class="text-xs text-gray-500">Baris yang tidak diisi (Pilih Gejala) akan diabaikan saat penyimpanan.</p>
              </div>
          </fieldset>

        <div class="mt-6 flex justify-center gap-3">
    
    <button class="px-5 py-2.5 text-sm font-medium text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition duration-150">
        Simpan Perubahan
    </button>

    <a href="{{ url_for('rule_bp.groups') }}"
       class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition duration-150">
        Batal
    </a>

</div>

    </form>
    
    <script>
        (function(){
            const rowsContainer = document.getElementById('rows');
            const btnAdd = document.getElementById('btnAdd');
            const defaultTerms = {{ default_terms | tojson }}; // Ambil term dari Jinja

            // 1. Fungsi untuk membuat baris baru (cloned from the first row or generated)
            function createNewRow(isCloning = false) {
                // Ambil struktur dasar dari baris yang sudah ada
                const existingRow = rowsContainer.querySelector('.condition-row');
                
                let clone;
                if (existingRow) {
                    clone = existingRow.cloneNode(true);
                    clone.querySelectorAll('select').forEach(s => s.value = '');
                    clone.querySelectorAll('.col-span-2 button').forEach(b => b.addEventListener('click', removeRow));
                } else {
                    // Fallback: Buat elemen jika tidak ada baris awal (seharusnya tidak terjadi)
                    clone = document.createElement('div');
                    clone.className = 'grid grid-cols-12 gap-3 condition-row p-3 bg-gray-50 rounded-lg border border-gray-200';
                    clone.innerHTML = `
                        <div class="col-span-5">
                            <select name="kode_gejala[]" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Gejala</option>
                                {% for g in gejala %}
                                    <option value="{{ g.kode }}">{{ g.kode }} - {{ g.nama }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-span-5">
                            <select name="antecedent_term[]" class="border border-gray-300 rounded-lg w-full px-4 py-2.5 bg-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">Pilih Term</option>
                                ${defaultTerms.map(t => `<option value="${t}">${t.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-span-2 flex items-center justify-end">
                            <button type="button" class="btn-remove p-2 text-red-600 hover:text-red-800 rounded-full hover:bg-red-100 transition duration-150" title="Hapus Kondisi">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    clone.querySelector('.btn-remove').addEventListener('click', removeRow);
                }
                
                return clone;
            }

            // 2. Event Listener untuk Menghapus Baris
            function removeRow(event) {
                const row = event.currentTarget.closest('.condition-row');
                if (rowsContainer.childElementCount > 1) { // Hanya hapus jika ada lebih dari 1 baris
                    row.remove();
                } else {
                    alert('Minimal harus ada satu baris kondisi.');
                }
            }

            // 3. Tambahkan Event Listener ke semua tombol hapus yang sudah ada
            rowsContainer.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', removeRow);
            });

            // 4. Event Listener untuk Menambah Baris
            if (btnAdd) {
                btnAdd.addEventListener('click', function(){
                    const newRow = createNewRow(true);
                    rowsContainer.appendChild(newRow);
                });
            }
        })();
    </script>
</div>
{% endblock %}