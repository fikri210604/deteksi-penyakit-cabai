{% extends 'app.html' %}
{% block title %}Tambah Kelompok Rule - Admin{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto py-8">
    
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center"> Tambah Kelompok Rule (Multi-Gejala)</h1>
    
    <form method="post" class="bg-white rounded-xl shadow p-8 border border-gray-200 space-y-8">

        <!-- Fieldset Kondisi -->
        <fieldset class="space-y-4 border border-gray-300 p-6 rounded-lg bg-white transition duration-300 hover:shadow-md">
            <legend class="text-xl font-semibold text-gray-700 px-2">Kondisi Rule (IF...)</legend>
            
            <p class="text-sm text-gray-600 text-center">
                Definisikan minimal dua kondisi Gejala. Baris kosong akan diabaikan.
            </p>

            <div id="rows" class="space-y-3">
                {% set default_terms = ['tidak_ada','sedikit','sedang','banyak','sangat_banyak'] %}

                {% for i in range(2) %}
                    <div class="grid grid-cols-12 gap-3 condition-row p-3 bg-white rounded-lg border border-gray-200 shadow-sm hover:border-gray-400 transition">
                        
                        <div class="col-span-5">
                            <label class="sr-only">Gejala</label>
                            <select name="kode_gejala[]" class="border rounded-lg w-full px-4 py-2.5 bg-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="" selected>Pilih Gejala</option>
                                {% for g in gejala %}
                                    <option value="{{ g.kode }}">{{ g.kode }} - {{ g.nama }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-span-5">
                            <label class="sr-only">Term</label>
                            <select name="antecedent_term[]" class="border rounded-lg w-full px-4 py-2.5 bg-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="" selected>Pilih Term</option>
                                {% for t in default_terms %}
                                    <option value="{{ t }}">{{ t | replace('_',' ') | title }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-span-2 flex items-center justify-end">
                            <button type="button" class="btn-remove p-2 text-red-600 hover:text-red-800 rounded-full hover:bg-red-100 transition" title="Hapus Kondisi">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="pt-4 flex justify-between items-center">
                <button type="button" id="btnAdd"
                    class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition">
                    Tambah Kondisi Gejala
                </button>
                <p class="text-xs text-gray-500">Baris yang tidak diisi akan diabaikan.</p>
            </div>
        </fieldset>

        <!-- Fieldset Konsekuen -->
        <fieldset class="space-y-4 border border-gray-300 p-6 rounded-lg bg-white transition duration-300 hover:shadow-md">
            <legend class="text-xl font-semibold text-gray-700 px-2">Konsekuen Rule (THEN...)</legend>
            
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelompok (Opsional)</label>
                    <input id="nama" name="nama" class="border rounded-lg w-full px-4 py-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="misal: Aturan P2 Kombinasi A">
                </div>
                <div class="md:col-span-2">
                    <label for="keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Rule (Opsional)</label>
                    <textarea id="keterangan" name="keterangan" rows="3" class="border rounded-lg w-full px-4 py-2.5 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>

            <div class="grid md:grid-cols-4 gap-4 pt-4 border-t border-dashed border-gray-300">
                <div>
                    <label for="kode_penyakit" class="block text-sm font-medium text-gray-700 mb-1">Penyakit</label>
                    <select id="kode_penyakit" name="kode_penyakit" class="border rounded-lg w-full px-4 py-2.5 bg-white focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Pilih Penyakit</option>
                        {% for p in penyakit %}
                            <option value="{{ p.kode_penyakit }}">{{ p.kode_penyakit }} - {{ p.nama }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="consequent_term" class="block text-sm font-medium text-gray-700 mb-1">Term (Sugeno)</label>
                    <select id="consequent_term" name="consequent_term" class="border rounded-lg w-full px-4 py-2.5 bg-white focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>Pilih Term</option>
                        <option value="rendah">rendah</option>
                        <option value="sedang">sedang</option>
                        <option value="tinggi">tinggi</option>
                    </select>
                </div>

                <div>
                    <label for="bobot" class="block text-sm font-medium text-gray-700 mb-1">Bobot Rule</label>
                    <input id="bobot" name="bobot" type="number" min="0" max="1" step="0.1" value="1" class="border rounded-lg w-full px-4 py-2.5 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex items-center pt-6">
                    <input id="aktif" name="aktif" type="checkbox" checked class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="aktif" class="ml-2 text-sm font-medium text-gray-700">Aktifkan Rule</label>
                </div>
            </div>

            <div>
                <label for="z_override" class="block text-sm font-medium text-gray-700 mb-1">Z Override (Opsional)</label>
                <input id="z_override" name="z_override" type="number" min="0" max="1" step="0.01" class="border rounded-lg w-full px-4 py-2.5 focus:ring-blue-500 focus:border-blue-500" placeholder="Misal: 0.7">
                <p class="text-xs text-gray-500 mt-1">Jika diisi, menggantikan nilai z default.</p>
            </div>
        </fieldset>

        <!-- Tombol -->
        <div class="mt-8 flex justify-center gap-4">
        <button class="px-6 py-2.5 text-sm font-medium text-white bg-green-600 rounded-lg shadow hover:bg-green-700 transition">
        Simpan Rule
        </button>

      <a href="{{ url_for('rule_bp.groups') }}"
        class="px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 transition shadow">
        Batal
    </a>
  </div>


    </form>

    <script>
        (function(){
            const rowsContainer = document.getElementById('rows');
            const btnAdd = document.getElementById('btnAdd');

            function removeRow(e){
                const row = e.currentTarget.closest('.condition-row');
                if(rowsContainer.childElementCount > 1){
                    row.remove();
                } else {
                    alert("Minimal satu kondisi diperlukan.");
                }
            }

            rowsContainer.querySelectorAll('.btn-remove').forEach(btn=>{
                btn.addEventListener('click', removeRow);
            });

            btnAdd.addEventListener('click', ()=>{
                const sample = rowsContainer.querySelector('.condition-row');
                const clone = sample.cloneNode(true);

                clone.querySelectorAll('select').forEach(s=>s.value="");
                clone.querySelector('.btn-remove').addEventListener('click', removeRow);

                rowsContainer.appendChild(clone);
            });
        })();
    </script>

</div>
{% endblock %}
